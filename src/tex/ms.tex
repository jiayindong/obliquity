% Define document class
\documentclass[twocolumn,times]{aastex631}
\usepackage{showyourwork}
\usepackage{xspace}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\usepackage{physics}
\usepackage[super]{nth}
\usepackage{fontawesome}
\usepackage{hyperref}

\newcommand{\dfm}[1]{\textcolor{blue}{\textbf{From DFM:} #1}}
\newcommand{\edits}[1]{\textcolor{grey}{\textbf{Edits:} #1}}

\received{}
\revised{}
\accepted{}

\submitjournal{the AAS Journals}

% Begin!
\begin{document}

% Title
\title{A Hierarchical Bayesian Framework for Inferring the Stellar Obliquity Distribution}

\correspondingauthor{Jiayin Dong}
\email{jdong@flatironinstitute.org}

\newcommand{\FlatironCCA}{Center for Computational Astrophysics, Flatiron Institute, 162 Fifth Avenue, New York, NY 10010, USA}

\author[0000-0002-3610-6953]{Jiayin Dong}
\altaffiliation{Flatiron Research Fellow}
\affiliation{\FlatironCCA}

\author[0000-0002-9328-5652]{Daniel Foreman-Mackey}
\affiliation{\FlatironCCA}

\received{}
\revised{}
\accepted{}

\submitjournal{the AAS Journals}

% Abstract with filler text
\begin{abstract}

Stellar obliquity $\psi$, the angle between a planet's orbital axis and its host star's spin axis, traces the formation and evolution of a planetary system. In transiting exoplanet observations, only the sky-projected stellar obliquity $\lambda$ can be measured. To determine the true stellar obliquity $\psi$, information about the stellar inclination $i_\star$ is also needed.
In this paper, we demonstrate that while a constraint on the stellar inclination is crucial for measuring the obliquity of an individual system, it is not required for robust determination of the population-level stellar obliquity distribution. 
In practice, the constraints on the stellar obliquity distribution are mainly driven by the sky-projected stellar obliquities.
We introduce a flexible, hierarchical Bayesian framework that can be used to infer the stellar obliquity distribution solely from sky-projected stellar obliquities, including stellar inclination measurements when available.
When applying the framework to all exoplanetary systems with measured sky-projected stellar obliquity, we find that the inferred population-level obliquity distribution is unimodal and peaked at zero degrees. Misaligned systems have nearly isotropic stellar obliquities, which could have important implications for the formation and evolution of close-in planets.

\end{abstract}

% Main body with filler text
\section{Introduction}
\label{sec:intro}

The stellar obliquity $\psi$ is the angle between a planet's orbital axis $\bf{n}_{\rm orb}$ and the host star's spin axis $\bf{n}_{\star}$. 
This angle is an important tracer of a planetary system's formation environment and dynamical evolution. The evolution of stellar obliquity can be roughly broken down into three stages. First, the formation and evolution of a protoplanetary disk determine the primordial stellar obliquity \citep[e.g.,][]{Bate10, Lai11, Batygin12}. Second, post-formation dynamical evolution in the planetary system, such as planet-planet scattering \citep[e.g.,][]{Rasio96, Chatterjee08, Nagasawa08, Beague12}, von Zeipel-Kozai-Lidov mechanisms \citep[e.g.,][]{Wu03, Naoz16}, and secular chaos \citep{Wu11}, can excite the mutual inclinations between planetary or stellar companions and alter the stellar obliquity. Lastly, the tidal force can reduce the stellar obliquity by realigning the host star's spin axis with the planet's orbital axis, if the tidal dissipation in the star is efficient \citep[e.g.,][]{Winn10, Albrecht12}. Additionally, massive stars with convective cores could generate internal gravity waves and dissipate angular momentum to their radiative zones, potentially affecting the stellar obliquity \citep{Rogers12, Rogers13}.

It is as yet unclear if, and to what extent, all of these physical and dynamic processes apply to exoplanetary systems. These proposed mechanisms all make different predictions on stellar obliquity distributions \citep[see][and references therein]{Albrecht22}. For example, the secular chaos mechanism tends to produce a stellar obliquity distribution with $\psi < 90\degr$ \citep[e.g.,][]{Teyssandier19}. The stellar Kozai mechanism predicts a bimodal stellar obliquity distribution, concentrated at $40\degr$ and $140\degr$ \citep[e.g.,][]{Fabrycky07, Anderson16, Vick19}. The multiple-planet scattering mechanism results in a majority of aligned systems, with a small fraction of systems at a diverse range of stellar obliquities \citep[e.g.,][]{Beague12}. 
With these predictions in mind, we aim to determine the dominant mechanisms responsible for shaping close-in planetary systems by characterizing the stellar obliquity distribution of exoplanetary systems through a Bayesian approach.

When observing an exoplanet, typically only the sky-projected stellar obliquity $\lambda$, the angle between the projections of $\bf{n}_{\rm orb}$ and $\bf{n}_{\star}$ onto the plane of the sky, can be measured. This measurement is primarily obtained via the Rossiter-McLaughlin effect \citep{Rossiter24, McLaughlin24}. The stellar obliquity $\psi$ for an individual exoplanet system can be inferred, if both the sky-projected stellar obliquity $\lambda$ and the stellar inclination $i_\star$ are measured precisely. The relationship between $\psi$ and $\{\lambda, i_\star\}$ is given by \citep[e.g.,][]{Fabrycky09}:
\begin{equation}\label{eqn:psi}
    \cos{\psi} = \sin{i_\star}\sin{i_{\rm orb}}\cos{\lambda} + \cos{i_\star}\cos{i_{\rm orb}},
\end{equation}
where $i_{\rm orb}$ is the inclination angle between the vector $\bf{n}_{\rm orb}$ and the observer's line of sight, and $i_\star$ is the inclination angle between $\bf{n}_{\star}$ and the observer's line of sight.
If an exoplanet system transits, the orbit is nearly edge-on ($i_{\rm orb} \approx 90\degr$), so in those cases, this relationship becomes approximately
\begin{equation}
\cos{\psi} \approx \sin{i_\star}\cos{\lambda}\,,
\end{equation}
although this is not a simplification that we are required to make in this paper.

In some cases, stellar inclinations can be constrained via, for example, photometric and spectroscopic rotational modulation introduced by starspots for cool stars \citep[e.g.,][]{Masuda20, Albrecht21}, gravity darkening for fast-rotating stars \citep[e.g.,][]{Barnes09, Barnes11}, and asteroseismology for bright stars \citep[e.g.][]{Chaplin13}.
However, for the vast majority of exoplanet systems, $i_\star$ measurements are not feasible. In these cases, it is still possible to infer their stellar obliquities from the sky-projected obliquities, assuming isotropic stellar inclinations; however, the inferred $\psi$ will have greater uncertainty than the one inferred with $i_\star$ measurement \citep{Fabrycky09}.

The relationship between the distributions of stellar obliquity, sky-projected stellar obliquity, and stellar inclination is still not fully understood. In this study, we aim to gain a deeper understanding of this relationship and develop a statistical approach to infer the stellar obliquity distribution.
In Section~\ref{sec:hbm}, we introduce a flexible, hierarchical Bayesian framework that allows us to infer the stellar obliquity distribution of a sample.
In Section~\ref{sec:applications}, we apply the framework to simulated data and real observations and show that the inferred stellar obliquity distribution from sky-projected stellar obliquities is robust even if the $i_\star$ information is not provided.
In Section~\ref{sec:jacobian}, we further investigate the relationship between the distributions of $\psi$, $\lambda$, and $i_\star$, and explain why sky-projected stellar obliquities play a predominant role in determining the inferred distribution of stellar obliquities.

\section{Hierarchical Bayesian Framework}\label{sec:hbm}

To find the stellar obliquity distribution of exoplanetary systems, we develop a hierarchical Bayesian framework that takes measurements of the observed sky-projected stellar obliquity $\lambda$ and orbital inclination $i_{\rm orb}$ as input data.
If a measurement of the stellar inclination $i_\star$ is available, it can be provided or inferred from the stellar rotation period $P_{\rm rot}$, stellar radius $R_\star$, and sky-projected rotational broadening velocity $v\sin{i}_\star$.
In the absence of an $i_\star$, $P_{\rm rot}$, or $v\sin{i}_\star$ measurement, we marginalize over the value of $i_\star$ using an isotropic prior distribution.

\begin{figure}[ht!]
    \script{graph.py}
    \includegraphics[width=\linewidth]{figures/graph.pdf}
    \caption{A probabilistic graphical model showing the conditional structure of our hierarchical Bayesian framework for inferring the stellar obliquity distribution of exoplanetary systems. The population model is parameterized by hyperparameters $\vb*{\beta}$, and it is constrained by the sky-projected stellar obliquity $\lambda_n$, orbital inclination $i_{{\rm orb}, n}$, and, if available, the stellar inclination $i_{\star, n}$ of each $n_{\rm th}$ individual system. Each system's stellar obliquity $\psi_n$ is inferred simultaneously based on these data. 
    Properties of the star other than its inclination, such as its radius and rotation period, are represented by $\gamma_{\star, n}$, and these can inform the constraint on $i_{\star, n}$, if available. 
    Obs$_{\star,n}$ contains all observed properties of the star with uncertainties, $\hat{\lambda}_n$ has the measured sky-projected stellar obliquity and its uncertainty, and $\hat{i}_{{\rm orb}, n}$ has measured orbital inclination and its uncertainty.}
    \label{fig:graph}
\end{figure}

Figure~\ref{fig:graph} illustrates the probabilistic graphical model for our hierarchical Bayesian framework. We aim to constrain a set of hyperparameters $\bm{\beta}$ that describe the stellar obliquity distribution. The parameter set $\bm{\beta}$ is constrained by $N$ individual systems, where each $\psi_n$ is simultaneously fit based on the entire sample of sky-projected stellar obliquities $\lambda_n$, orbital inclinations $i_{{\rm orb},n}$, and if available, the stellar inclination $i_{\star, n}$. 
The parameter $\gamma_{\star, n}$ contains all stellar properties other than $i_{\star,n}$, such as the stellar rotation period $P_{{\rm rot},n}$, radius $R_{\star,n}$, and projected rotational velocity $v\sin{i_{\star,n}}$, if they are known.

In Figure~\ref{fig:graph}, the observed values of $\lambda_n$ and $i_{{\rm orb},n}$ are indicated by $\hat{\lambda}_n$ and $\hat{i}_{{\rm orb},n}$, respectively.
The $\hat{\lambda}_n$ measurements typically come from the Rossiter-McLaughlin effect or gravity darkening, and the $\hat{i}_{{\rm orb},n}$ is constrained by the transit light curve.

The constraints on stellar inclination are somewhat more complicated.
In Figure~\ref{fig:graph}, the Obs$_{\star,n}$ node includes any observed data that directly constrains $i_{\star,n}$.
This could include a direct measurement of $\hat{i}_{\star,n}$ \citep[via gravity-darkening or asteroseismology, for example][]{Barnes09, Chaplin13}, or a measurement of the sky-projected stellar rotational line broadening $\hat{v}\sin{i_{\star,n}}$, which is related to $i_\star$ as $v\sin{i_\star} = 2 \pi R_\star / P_{\rm rot}$ \citep{Masuda20}.

% If the rotational modulation method is used to constrain the stellar inclination, the $i_{\star,n}$ and $\gamma_{\star,n}$ are constrained by rotational modulation in photometric or spectroscopic time series and observed sky-projected stellar rotational line broadening $\hat{v}\sin{i_{\star,n}}$ \citep[e.g.,][]{Masuda20}, where we have $v\sin{i_\star} = 2 \pi R_\star / P_{\rm rot}$.
% If the gravity-darkening method is used, the $i_{\star,n}$ could be constrained by the anomaly in transit light curves \citep{Barnes09}. If asteroseismology is used, the $i_{\star,n}$ could be constrained from the mode splitting in the Fourier transform of photometric time series \citep{Chaplin13}.

For the stellar obliquity distribution, we model the $\cos{\psi}$ distribution instead of $\psi$ distribution to understand if the stellar obliquity is isotropically distributed.
If stellar obliquity distribution is isotropic, $\cos{\psi}$ is uniformly distributed between -1 to 1.
To flexibly model the stellar obliquity distribution, we select a two-component mixture of Betas distribution with hyperparameters $\bm{\beta} = \{\bm{w},\bm{a},\bm{b}\}$, where each hyperparameter has a dimension of 2.
This mixture distribution has the capacity to capture anything from an isotropic distribution to a strongly bimodal population.
% One component is designed for a large population of well-aligned systems, and the other is designed for misaligned systems. The Beta distribution is a flexible distribution that can describe the spike of aligned systems with stellar obliquities close to $0\degr$ or the clustered or broadly distributed misaligned systems.
\dfm{The notation here is a bit sloppy. It might be better to say something like: there's some parameter $x \sim \mathrm{mixture}$ which we then transform as $2\,x-1$, which isn't quite the same.}
Then, under this model, the probability density function for $\cos{\psi}$ is 
\begin{align}
    \cos{\psi} &\sim 2\,\Bigl( w_0 {\rm Beta}(a_0, b_0) + w_1 {\rm Beta}(a_1, b_1)\Bigr)-1.
\end{align}
Since the Beta distribution is defined on the interval $[0, 1]$, we extend its support to $[-1,1]$ using a linear transformation (i.e., $2\,{\rm Beta} - 1$). 

\dfm{I'm not sure that I understand this next bit. Why and how do we do this?}
For the ${\rm Beta}(a_0,b_0)$ component, we have it to describe the population of aligned systems. For the $a_0/b_0 \gg 1$, the distribution will have a spike at $\cos{\psi} = 1$. For the ${\rm Beta}(a_1,b_1)$ component, we have it to describe the misaligned systems.

We design the order of the two components to prevent label switching in the mixture model \dfm{how?}.
With the design, the hyperparameter and parameter priors are the following:
\begin{align}
    w_{0,1} &\sim {\rm Dirichlet}(1, 1) \nonumber\\
    a_0 &\sim \mathcal{U}(0, 50) \nonumber\\
    b_0 &\sim \mathcal{U}(0, 1) \nonumber\\
    a_1 &\sim \mathcal{U}(0, 10) \nonumber\\
    b_1 &\sim \mathcal{U}(0, 10) \nonumber\\
    \cos{i}_{\star,n} &\sim \mathcal{U}(0, 1) \nonumber\\
    \cos{i}_{{\rm orb},n} &\sim \mathcal{U}(0, 1) \nonumber\\
    \lambda_{\star,n} &\sim \mathcal{U}(-\pi, \pi).
\end{align}
The likelihood functions follow:
\begin{align}
    \mathcal{L}(\lambda) &\sim \prod_{i=1}^N\mathcal{N}(\hat{\lambda}_n, \sigma_{\hat{\lambda}_n}) \nonumber\\
    \mathcal{L}(i_{\rm orb}) &\sim \prod_{i=1}^N\mathcal{N}(\hat{i}_{{\rm orb},n}, \sigma_{\hat{i}_{{\rm orb},n}}) \nonumber\\
    \mathcal{L}(i_\star) &\sim \prod_{i=1}^N\mathcal{N}({\rm Obs}_{\star,n}, \sigma_{{\rm Obs}_{\star,n}}).
\end{align}
If $\gamma_{\star, n}$ is available, we construct Normal distributions with means and standard deviations from measurements.
Here we use uniform hyperpriors for the Beta distribution. However, it is important to note that when applying the framework to a small sample size with $N \lesssim 50$, the choice of hyperpriors could impact the inferred distribution \citep{Nagpal22}. To ensure the robustness of the inferred distributions in such cases, it is crucial to test their sensitivity to different hyperpriors.

The probabilistic model is constructed using the $\mathtt{PyMC}$ package version $\mathtt{v4.1.7}$ \citep{pymc}, and the posteriors are sampled with the No-U-Turn Sampler \citep[NUTS;][]{Hoffman11}, which is a gradient-based Markov chain Monte Carlo (MCMC) sampling algorithm. This paper's figures and simulations are completely reproducible and were created using the \showyourwork package. The open-source code is available on \href{https://github.com/jiayindong/obliquity}{GitHub\,\faGithub\,(https://github.com/jiayindong/obliquity)}.

\section{Applications to Simulated and Observed Data}\label{sec:applications}

\subsection{Simulated Data}\label{subsec:sims}

To investigate the performance of our hierarchical Bayesian framework, we apply it to simulated data, generated with a known ground-truth stellar obliquity distribution.
We test the following four $\cos{\psi}$ distributions: a uniform distribution $\mathcal{U}(-1,1)$, and three Normal distributions $\mathcal{N}(0,0.2)$, $\mathcal{N}(-0.4,0.2)$, and $\mathcal{N}(0.4,0.2)$.
\dfm{For these normals, we must truncate, since they have support outside of 0--1. How is that implemented; should we mention it explicitly?}
For each $\cos{\psi}$ distribution, we randomly generate 200 samples of stellar inclination $i_\star$ and sky-projected stellar obliquity $\lambda$. We assume the stellar spin axis is uniformly distributed around the planetary orbital axis in the azimuthal direction and the orbital inclination is $90\degr$. 
The sampled $i_\star$ and $\lambda$ here are \emph{true} values. 
To simulate the observation process, we add Gaussian noise to the \emph{true} $\lambda$ and $i_\star$, using uncertainties of $\sigma_{\lambda} = 8\degr$ and $\sigma_{i_\star} = 10\degr$, which are typical of the literature sample \cite{Albrecht22}.
Using these simulated $\lambda$ measurements and their uncertainties, we infer the $\cos{\psi}$ distribution of the sample with or without $i_\star$ likelihoods. 

In Figure~\ref{fig:simulation}, we present the results of this experiment, plotting the inferred stellar obliquity distributions, compared to the ground-truth distributions.
Since the simulated stellar obliquity distributions only have a single component, we model the data with a single Beta distribution.
Each row of Figure~\ref{fig:simulation} corresponds to a different simulation distribution. The orange curve and contours in the left column are the median, 1-$\sigma$ and 2-$\sigma$ uncertainties of the inferred $\cos{\psi}$ distribution with stellar inclination information.
The right column shows the same inferences (in blue) when constraints on stellar inclination are not included.
% We simply assume an isotropic distribution of $i_\star$ for these models.
Surprisingly, Figure~\ref{fig:simulation} demonstrates that our inference procedure recovers the true distribution for $\cos{\psi}$ equally well, regardless of the inclusion of $i_\star$ measurements.
Despite the fact that the inferred distributions without $i_\star$ measurements have marginally wider uncertainties, as indicated by shallow color contours, the modes and widths of the inferred stellar obliquity distributions are consistent with or without $i_\star$ likelihood.
Since the injected distributions in rows 2-4 are Normal distributions, it should not be surprising that the inferred distributions, which are Beta distributions, may not exactly match the injected distributions.
\dfm{Add some more here about how the true distribution is not included within the support of the distribution we're using to fit. One thought: perhaps we would actually do better if we used the two betas here too?}

We also examine the role of orbital inclination $i_{\rm orb}$ in the stellar obliquity distribution inference. Since our study focuses on transiting-exoplanet systems, we consider an isotropic orbital inclination distribution between $80\degr$ and $90\degr$. This broad range of inclinations corresponds to an impact parameter range from 0 to 1 with a planet-star separation $a/R_\star$ of 6.
We compare the stellar obliquity distributions obtained by approximating $i_{\rm orb}$ to $90\degr$ with the distributions obtained using the actual $i_{\rm orb}$. We find the difference between the two distributions is negligible. This suggests that for transiting-exoplanet systems, approximating orbital inclinations as $90\degr$ will not compromise the stellar obliquity distribution inference.

We demonstrate through simulations that the inferred stellar obliquity distribution is robust even if the $i_\star$ information is not provided, and the $i_\star$ measurement only improves the constraint on the stellar obliquity distribution. Later in Section~\ref{sec:jacobian}, we derive the Jacobian transformations between $\psi$, $\lambda$, and $i_\star$ to understand why sky-projected stellar obliquities play a predominant role in determining the inferred distribution of stellar obliquities.

\begin{figure}[ht!]
    \script{sim_plot.py}
    \includegraphics[width=\linewidth]{figures/simulation.pdf}
    \caption{Inferred stellar obliquity distributions from sky-projected stellar obliquities with and without information on the stellar inclination, depicted in blue and orange curves, respectively. Each row presents a set of simulated data with the true distribution of $\cos{\psi}$ indicated by grey dashed curves. The shallow contours represent the 1-$\sigma$ and 2-$\sigma$ uncertainties of the inferred distributions.}
    \label{fig:simulation}
\end{figure}

\subsection{The Stellar Obliquity Distribution of Observed Exoplanets}

We next apply our hierarchical Bayesian framework to a sample of 161 exoplanetary systems with sky-projected stellar obliquity measurements, primarily consisting of Hot Jupiter systems, as summarized in \cite{Albrecht22} Table A1.
The inferred $\cos{\psi}$ distribution is shown in Figure~\ref{fig:psi_dist}. The $\cos{\psi}$ distribution is peaked at 1, with nearly flat behavior between $-0.75$ and $0.75$ and no significant clustering. The distribution suggests that there is a pile-up of planetary systems with stellar obliquities less than $40^\circ$ and an isotropic distribution for obliquities between $40^\circ$ and $140^\circ$.
The fraction of aligned systems $w_0$ dominates the distribution, with $w_0 = 0.67 \pm 0.09$. The corresponding posteriors for the parameters of the population Beta distribution are $a_0 = 31.0\pm12.8$ and $b_0 = 0.40\pm0.12$. On the other hand, the fraction of misaligned systems is estimated to be $w_1 = 0.33 \pm 0.09$, with posteriors of $a_1 = 1.56\pm0.93$ and $b_1 = 1.64\pm1.58$.

\begin{figure}[ht!]
    \script{psi_plot.py}
    \begin{centering}
        \includegraphics{figures/psi_dist.pdf}
        \caption{Inferred stellar obliquity distribution for all exoplanetary systems with sky-projected stellar obliquity measurements. This inference is based purely on the observed sky-projected obliquities and assumes an isotropic distribution for the stellar inclinations.
        \dfm{Might be worth plotting the two mixture components too.}}
        \label{fig:psi_dist}
    \end{centering}
\end{figure}

The discrepancy between this inference for the full sample of exoplanet systems and the previous analysis of the subsample with $i_\star$ measurements \citep{Albrecht21} warrants further investigation.
This earlier study identified a preponderance (\dfm{maybe different word.}) of perpendicular planets and disfavored an isotropic stellar obliquity distribution \citep{Albrecht21}.
There are at least two potential explanations for this difference: (1) the subsample with $i_\star$ measurements is small and only includes about 20 misaligned systems, and (2) the requirement for $i_\star$ measurements could introduce selection biases in the sample.  \dfm{Expand on this a little bit, I think. Maybe add a short paragraph for each.}

The inferred stellar obliquity distribution indicates that approximately $67\pm9$\% of the systems have a stellar obliquity of less than $40\degr$, and approximately $33\pm9$\% of the systems follow a nearly isotropic stellar obliquity distribution ranging from $\sim$$40\degr$ to $\sim$$140\degr$. These findings could have significant implications for the formation and evolution of close-in planetary systems.
The broad distribution of misaligned systems is in good agreement with the predicted outcome of multiple giant planets scattering after a convergent disk migration, as proposed by various studies, such as \cite{Nagasawa11} and \cite{Beague12}. The intriguing result should be further examined with a more carefully selected sample of Hot Jupiters and provides opportunities to place constraints on their origin channels of Hot Jupiters.

\section{Relations between the $\psi$, $\lambda$, and \lowercase{$i_\star$} distributions}\label{sec:jacobian}

In this section, we aim to gain insight into the reasons behind the predominant role of the sky-projected stellar obliquity distribution and the less significant impact of the stellar inclination distribution in the inference of the stellar obliquity distribution.

\begin{figure*}[ht!]
    \script{coordinate.py}
    \gridline{
        \fig{figures/coord_psi.pdf}{0.45\textwidth}{\vspace*{-1.8cm}(a) The $\{\psi, \theta\}$ coordinate system. The grey circle corresponds to a constant $\psi$ value and its circumference is proportional to $\sin{\psi}$.}
        \fig{figures/coord_lam.pdf}{0.45\textwidth}{\vspace*{-1.8cm}(b) The $\{\lambda, i_\star\}$ coordinate system. The grey circle corresponds to a constant $i_\star$ value and its circumference is proportional to $\sin{i_\star}$.}
    }
    \vspace*{-1cm}
    \caption{Two coordinate systems that describe the stellar spin axis $\bf{n}_{\star}$ and the planet's orbital axis $\bf{n}_{\rm orb}$. Here we define the observer's line of sight as one of the horizontal axes (represented as the conventional $x$-axis in Cartesian coordinates), and the orbital axis of the planet as the vertical axis (represented as the conventional $z$-axis in Cartesian coordinates). We approximate the orbital inclination of the planet to $90\degr$.}
    \label{fig:coord}
\end{figure*}

In Figure~\ref{fig:coord}, we present two coordinate systems that describe the stellar spin axis $\bf{n}_{\star}$ for a given orbital axis $\bf{n}_{\rm orb}$. In both coordinates, we set the observer's line of sight to be one of the horizontal axes (represented as the conventional $x$-axis in Cartesian coordinates), and the orbital axis of the planet to be the vertical axis (represented as the conventional $z$-axis in Cartesian coordinates). To simplify the problem, the orbital inclination of the transiting planet is assumed to be $90\degr$ in this illustration. As discussed in Section~\ref{subsec:sims}, the assumption will not compromise the stellar obliquity distribution inference for transiting planets.

The $\{\psi, \theta\}$ coordinate system shown in panel (a) relates to the physical properties of a planetary system. $\psi$ is the angle between the stellar spin axis and the planetary orbital axis, and $\theta$ is the azimuthal angle of the stellar spin axis. For the given $\bf{n}_{\rm orb}$ axis, if $\bf{n}_{\star}$ is a random vector with uniform distribution on a three-dimensional sphere, i.e., $\bf{n}_{\star}$ is isotropically distributed, the probability density function of $\psi$ follows $p_{\psi} \sim \sin{\psi}$ and $p_\theta \sim 1/2\pi$. Since $p_{\cos{\psi}} = p_{\psi} \abs{\dv*{\psi}{\cos{\psi}}}$, $p_{\cos{\psi}}$ is uniformly distributed between $-1$ and $1$ for isotropic stellar obliquity.
The $\{\lambda, i_\star\}$ coordinate system shown in panel (b) relates to observed properties. $\lambda$ is the sky-projected stellar obliquity and $i_\star$ is the stellar inclination. If $\bf{n}_{\star}$ is isotropically distributed, $p_{i_\star} \sim \sin{i_\star}$ and $p_\lambda \sim \mathcal{U}(-\pi, \pi)$. Again, since $p_{\cos{i_\star}} = p_{i_\star} \abs{\dv*{i_\star}{\cos{i_\star}}}$, $p_{\cos{i_\star}}$ is uniformly distributed between $-1$ and $1$. 
Because of the observational degeneracy between $i_\star$ and $180\degr - i_\star$, the convention is to have $0 \leqslant i_\star \leqslant 90\degr$, and thus $p_{\cos{i_\star}}$ is uniformly distributed between $0$ and $1$ and $p_{\cos{i_\star}} \sim \mathcal{U}(0, 1)$. This also limits $p_\theta \sim \mathcal{U}(-\pi/2, \pi/2)$.

We could find the mathematical relations between $\{\psi, \theta\}$ and $\{\lambda, i_\star\}$ by pairing the Cartesian components of $\bf{n}_{\star}$ in two coordinate systems:
\begin{align}
    \sin{\psi}\cos{\theta} = \cos{i_\star}& \label{eq:coord1}\\
    \sin{\psi}\sin{\theta} = \sin{\lambda}\sin{i_\star}& \label{eq:coord2}\\
    \cos{\psi} = \cos{\lambda}\sin{i_\star} \label{eq:coord3}&.
\end{align}

First, we derive the $\lambda$ distribution for a given $\cos{\psi}$ distribution. We could find the distribution of $\cos{\lambda}$ using the Jacobian transformation from $\cos{\psi}$ and $\cos{\theta}$. Since $\psi$ and $\theta$ are independent variables, we could marginalize over $\theta$ to find the relation between the probability density functions between $\lambda$ and $\psi$.
The Jacobian transformation follows
\begin{equation}
    p_{\cos{\lambda}} = \int \abs{\pdv{\cos{\psi}}{\cos{\lambda}}} p_{\cos{\psi}} p_{\cos{\theta}} d\cos{\theta}.
\end{equation}
Replacing $\sin{i_\star}$ in Equation~(\ref{eq:coord3}) using Equation~(\ref{eq:coord1}), we find $\cos{\lambda} = \cos{\psi}/\sqrt{1-(1-\cos^2{\psi})\cos^2{\theta}}$. Reorganize the equation, we get $\cos^2{\psi} = \frac{\cos^2{\lambda}\cos^2{\theta}-\cos^2{\lambda}}{\cos^2{\lambda}\cos^2{\theta}-1}$ and
the partial derivative $\abs{\pdv{\cos{\psi}}{\cos{\lambda}}} = \frac{(1-\cos^2{\theta})^{1/2}}{(1-\cos^2{\theta}\cos^2{\lambda})^{3/2}}$. Assume $\theta$ is uniformly distributed between $-\pi/2$ and $\pi/2$, $p_{\cos{\theta}} = p_{\theta} \abs{\dv*{\theta}{\cos{\theta}}} = 2/\pi/(1-\cos^2{\theta)^{1/2}}$, where the factor of 2 is due to two solutions of $\theta$ to the $\cos{\theta}$. Putting all the parts together, we get
\begin{equation}\label{eqn:jac_lam}
    p_{\cos{\lambda}} = \frac{2}{\pi} \int_{0}^{1} (1-\cos^2{\theta}\cos^2{\lambda})^{-3/2} p_{\cos{\psi}} d\cos{\theta}.
\end{equation}
If $\cos{\psi}$ is uniformly distribution, i.e., $p_{\cos{\psi}} \sim 1/2$, Equation~(\ref{eqn:jac_lam}) becomes $p_{\cos{\lambda}} \sim 1/\pi/\sqrt{1-\cos^2{\lambda}}$, which is equivalent to $p_\lambda \sim \mathcal{U}(-\pi, \pi)$. This suggests $\lambda$ is uniformly distributed for an isotropic $\psi$ distribution. For different $\cos{\psi}$ distributions, $p_\lambda$ can be found by evaluating Equation~(\ref{eqn:jac_lam}).

Next, we derive the $i_\star$ distribution for a given $\cos{\psi}$ distribution. Similarly, we first find the Jacobian transformation of $i_\star$ from $\psi$ and $\theta$ and then marginalize over $\theta$. It is easier to work on $\cos{i_\star}$ than $i_\star$:
\begin{equation}
    p_{\cos{i_\star}} = \int \abs{\pdv{\sin{\psi}}{\cos{i_\star}}} p_{\sin{\psi}} p_{\cos{\theta}} d\cos{\theta}.
\end{equation}
From Equation~(\ref{eq:coord1}), we have $\sin{\psi} = \cos{i_\star}/\cos{\theta}$ and $\abs{\pdv{\sin{\psi}}{\cos{i_\star}}} = 1/\cos{\theta}$. Again, we assume $\theta$ is uniformly distributed, and this gives $p_{\cos{\theta}} = 2/\pi/(1-\cos^2{\theta)^{1/2}}$. Lastly, we transform the $p_{\sin{\psi}}$ to $p_{\cos{\psi}}$, where $p_{\sin{\psi}} = 2p_{\cos{\psi}}\sin{\psi}/\sqrt{1-\sin^2{\psi}}$ and the factor of 2 is from two solutions of $\cos{\psi}$ to the $\cos^2{\psi} = 1-\sin^2{\psi}$. Combining all the pieces together, we get
\begin{equation}\label{eqn:jac_istar}
    p_{\cos{i_\star}} = \frac{4}{\pi} \int_{\cos{i_\star}}^{1} \frac{\cos{i_\star}/\cos{\theta}}{\sqrt{\cos^2{\theta}-\cos^2{i_\star}}} \frac{1}{\sqrt{1-\cos^2{\theta}}} p_{\cos{\psi}} d\cos{\theta}.
\end{equation}
Note that the lower limit of the integral is $\cos{i_\star}$ instead of 0 since $\lvert \cos{\theta}/\cos{i_\star} \rvert \geqslant 1$.
If $\cos{\psi}$ is uniformly distribution, i.e., $p_{\cos{\psi}} \sim 1/2$, the integral gives $1$, which suggests the $\cos{i_\star}$ is uniformly distributed, as expected.

Using Equation~(\ref{eqn:jac_lam}) and (\ref{eqn:jac_istar}), we can now derive the $\lambda$ and $i_\star$ distributions for any given $\psi$ distributions, assuming the azimuthal angle of the stellar spin axis $\theta$ is random. In Figure~\ref{fig:transform}, we present numerical solutions of the $\lambda$ and $i_\star$ distributions for four different $\cos{\psi}$ distributions. The top row of Figure~\ref{fig:transform} shows an isotropic $\psi$ distribution, where $\cos{\psi} \sim \mathcal{U}(-1,1)$. The second, third, and fourth rows of Figure~\ref{fig:transform} present Normal distributions of $\cos{\psi}$ following $\mathcal{N}(0,0.2)$, $\mathcal{N}(-0.4,0.2)$, and $\mathcal{N}(0.4,0.2)$, respectively. 
The blue curves in each row show the numerical solutions of the $\lambda$ and $i_\star$ distributions, while the grey histograms show the sampling of $\lambda$ and $i_\star$ from the $\cos{\psi}$ and $\theta$ distributions. 
For a uniform $\cos{\psi}$ distribution, the $\lambda$ distribution is uniform, and the $i_\star$ distribution is isotropic, proportional to $\sin{i_\star}$, as expected.

Interestingly, the $\lambda$ distribution is closely related to and sensitive to the underlying $\psi$ distribution, as demonstrated in the \nth{1} and \nth{2} columns in Figure~\ref{fig:transform}. For different stellar obliquities, the $\lambda$ distributions are distinguishable, making it possible to infer the $\psi$ distribution from the $\lambda$ distribution. On the other hand, the $i_\star$ distributions are less dependent on the underlying $\psi$ distribution. Compared to an isotropic $i_\star$ distribution, the curvature of the $i_\star$ distributions for different $\psi$ distributions differ the most at the low $i_\star$ values (i.e., $i_\star < \pi/4$), which places a challenge to observational detections. 
Additionally, the degeneracy of the solution could be a significant issue when attempting to infer the $\psi$ distribution from the $i_\star$ distribution. For example, when $\cos{\psi} \sim \mathcal{N}(-0.4,0.2)$ or $\cos{\psi} \sim \mathcal{N}(0.4,0.2)$, two $i_\star$ distributions are exactly the same.

The $\psi$ distribution can be inferred from the $\lambda$ distribution without loss of information due to the strong dependency of the $\lambda$ distribution on the $\psi$ distribution. It is also worthwhile to note that although we could find a mathematical expression of $\psi$ with $\lambda$ and $\theta$, the $\psi$ distribution cannot be inferred from the two variables since they are not independent variables.

In the \nth{4} column in Figure~\ref{fig:transform}, the $\psi$ distribution is found from the $\lambda$ distribution by assuming an isotropic $i_\star$ distribution. The method could accurately recover the peaks and widths of the underlying $\psi$ distributions (represented by blue dashed lines) shown in grey histograms. The method over-predicts $\cos{\psi}$ at $\pm 1$ because of the over-prediction of $i_\star$ near $90\degr$. However, this small deviation from the true distribution has a limited impact on population inference because of the hyperparameters have limited degrees of freedom. By comparing the blue curves with the orange curves in Figure~\ref{fig:simulation}, it can be seen that the overestimation of $\cos{\psi}$ near $\pm1$ under the assumption of isotropic $i_\star$ has little effect on the overall inference. The distribution is primarily determined by the peak and width of the stellar obliquity distribution, both of which are correctly predicted by the isotropic $i_\star$ model.

\begin{figure*}[ht!]
    \script{transform.py}
    \includegraphics[width=\linewidth]{figures/transform.pdf}
    \caption{Simulated $\cos{\psi}$ distributions (\nth{1} column) and the corresponding distributions of sky-projected stellar obliquity $\lambda$ (\nth{2} column) and stellar inclination $i_\star$ (\nth{3} column). The inferred $\cos{\psi}$ distributions assuming isotropic stellar inclinations are shown in the \nth{4} column. The grey histograms present the random samplings of $\lambda$ and $i_\star$ from the $\cos{\psi}$ distributions, and the blue curves present the numerical solutions.}
    \label{fig:transform}
\end{figure*}

\section{Summary \& Discussion}

In this work, we demonstrated that the stellar obliquity distribution could be robustly inferred from sky-projected stellar obliquities purely.
We introduced a flexible, hierarchical Bayesian framework for the stellar obliquity distribution inference. Stellar inclination measurements are optional input in the model, and if not available, they are assumed to be isotropically distributed.
Our open-source hierarchical Bayesian model, available on \href{https://github.com/jiayindong/obliquity}{GitHub\,\faGithub\,(https://github.com/jiayindong/obliquity)}, can be customized to different stellar obliquity distributions and priors for specific target samples.

It is crucial to consider the representativeness of the $i_\star$ sample when jointly modeling the stellar obliquity distribution from two data sets, one with and one without $i_\star$ measurements. An unrepresentative $i_\star$ sample could tighten the constraints on the stellar obliquities and bias the interpretation of the overall distribution.

Finally, we applied the framework to all exoplanetary systems to all exoplanetary systems with available sky-projected stellar obliquities and found that approximately $67\pm9$\% of the systems have a stellar obliquity less than $40\degr$, and approximately $33\pm9$\% of the systems follow a nearly isotropic stellar obliquity distribution between $\sim$$40\degr$ and $\sim$$140\degr$.
The distribution could have important implications for the formation and evolution of close-in planetary systems and is worth further investigation.

\section*{Acknowledgments}
We are grateful to Josh Winn and Jared Siegel for their valuable insights and feedback on this project.

This study was conducted using the \href{https://github.com/showyourwork/showyourwork}{\showyourwork} reproducible workflow \citep{Luger2021}, which leverages continuous integration to automate the data retrieval from \href{https://zenodo.org/}{zenodo.org}, figure generation, and manuscript compilation.
The script used to produce each figure can be accessed via a link in the corresponding figure caption, as it corresponds to the latest build of the manuscript.
The git repository for this study, which includes the Jupyter notebook demonstration and case studies of the stellar obliquity distribution inference, is publicly accessible at \url{https://github.com/jiayindong/obliquity}.

\vspace*{5mm}

\software{$\mathtt{ArviZ}$ \citep{arviz_2019}, $\mathtt{Jupyter}$ \citep{Jupyter}, $\mathtt{Matplotlib}$ \citep{Matplotlib07, Matplotlib16}, $\mathtt{NumPy}$ \citep{NumPy11, NumPy20}, $\mathtt{pandas}$ \citep{mckinney-proc-scipy-2010, reback2020pandas}, $\mathtt{PyMC}$ \citep{pymc}, $\mathtt{SciPy}$ \citep{2020SciPy-NMeth}, \showyourwork \citep{Luger2021}}

\bibliography{bib}

\end{document}
