% Define document class
\documentclass[twocolumn,times]{aastex631}
\usepackage{showyourwork}
\usepackage{xspace}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\usepackage{physics}
\usepackage[super]{nth}
\usepackage{fontawesome}
\usepackage{hyperref}

\received{}
\revised{}
\accepted{}

\submitjournal{the AAS Journals}

% Begin!
\begin{document}

% Title
\title{A Hierarchical Bayesian Framework for Exoplanetary Stellar Obliquity Distribution}

\correspondingauthor{Jiayin Dong}
\email{jdong@flatironinstitute.org}

\newcommand{\FlatironCCA}{Center for Computational Astrophysics, Flatiron Institute, 162 Fifth Avenue, New York, NY 10010, USA}

\author[0000-0002-3610-6953]{Jiayin Dong}
\altaffiliation{Flatiron Research Fellow}
\affiliation{\FlatironCCA}

\author[0000-0002-9328-5652]{Dan Foreman-Mackey}
\affiliation{\FlatironCCA}

\author{et al.}

% Abstract with filler text
\begin{abstract}

Stellar obliquity $\psi$, the angle between a planet's orbital axis and its host star's spin axis, traces the formation environment and dynamical evolution of a planetary system. In exoplanet observations, only the sky-projected stellar obliquity $\lambda$ can be measured. To find the true stellar obliquity, information about the stellar inclination $i_\star$ is required.
Here we show that, while it is important to know the stellar inclination to tightly constrain the stellar obliquity of an individual system, the stellar inclination is not necessarily required for the population stellar obliquity inference. The constraint on stellar obliquity distribution is predominantly based on sky-projected stellar obliquities.
We introduce a flexible, hierarchical Bayesian framework that allows inferring the stellar obliquity distribution from sky-projected stellar obliquities, and if available, stellar inclinations.
Applying the framework to all systems with sky-projected stellar obliquity measurements, mostly Hot Jupiter systems, we find that the stellar obliquity distribution is unimodal and peaked at zero degrees. Misaligned systems have nearly isotropic stellar obliquities, at odds with the analysis of systems that also have $i_\star$ measurements.

\end{abstract}

% Main body with filler text
\section{Introduction}
\label{sec:intro}

Stellar obliquity $\psi$ describes the angle between a planet's orbital axis $\bf{n}_{\rm orb}$ and its host star's spin axis $\bf{n}_{\star}$. 
The angle is an important tracer of a planetary system's formation environment and dynamical evolution. Stellar obliquity evolution can be roughly summarized into three stages. First, the formation and evolution of a protoplanetary disk around its host star determine the primordial stellar obliquity \citep[e.g.,][]{Bate10, Lai11, Batygin12}. Second, post-formation dynamical evolution in the planetary system, such as planet-planet scattering \citep[e.g.,][]{Rasio96, Chatterjee08, Nagasawa08, Beague12} and von Zeipel-Kozai-Lidov mechanisms \citep[e.g.,][]{Wu03, Naoz16}, excites the mutual inclinations between planetary or stellar companions, further sculpting the stellar obliquity. Lastly, tidal realignment of the host star's spin axis to the planet's orbital axis could reduce the stellar obliquity, if the stellar tidal dissipation is efficient \citep[e.g.,][]{Winn10, Albrecht12}. Furthermore, massive stars with convective cores could generate internal gravity waves and dissipate angular momentum to their radiative zones, thus modifying stellar obliquities \citep{Rogers12, Rogers13}.

It is yet unclear which one or more of these mechanisms predominantly sculpts the stellar obliquities in exoplanetary systems and the linkage between stellar obliquities and the formation pathways of close-in planets.
Because of tidal realignment, aligned systems could have had different stellar obliquities in the past, making it hard to trace the obliquity-sculpting mechanism.
On the other hand, misaligned systems with stellar obliquities that have not yet been washed out by tidal effects still provide clues on obliquity-sculpting mechanisms.
Proposed mechanisms have different predictions on the stellar obliquity distributions. For example, in the secular chaos mechanism, stellar obliquity (or more accurately mutual inclinations between planets) could never get beyond $90\degr$ \citep{Teyssandier19}; in the stellar Kozai mechanism, stellar obliquity distribution should peak at $40\degr$ and $140\degr$ \citep{Anderson16}.
Motivated by these predictions, we build a statistical model to characterize the stellar obliquity distribution of exoplanetary systems to distinguish between proposed stellar-obliquity-sculpting mechanisms.

In exoplanetary observation, only the sky-projected stellar obliquity $\lambda$, the angle between the projections of $\bf{n}_{\rm orb}$ and $\bf{n}_{\star}$ onto the plane of the sky, can be measured. Stellar obliquity $\psi$ can be found, if the stellar inclination $i_\star$ is known. The calculation follows \citep[e.g.,][]{Fabrycky09}:
\begin{equation}\label{eqn:psi}
    \cos{\psi} = \sin{i_\star}\sin{i_{\rm orb}}\cos{\lambda} + \cos{i_\star}\cos{i_{\rm orb}},
\end{equation}
where $i_{\rm orb}$ is the angle between the vector $\bf{n}_{\rm orb}$ and the observer's line of sight, and $i_\star$ is the angle between $\bf{n}_{\star}$ and the observer's line of sight.
For transiting exoplanet systems where $i_{\rm orb} \approx 90\degr$, $\cos{\psi} \approx \sin{i_\star}\cos{\lambda}$.

Stellar inclination can often be constrained via, e.g., photometric and spectroscopic rotational modulation introduced by starspots, gravity darkening, and asteroseismology \citep[see][and references therein]{Albrecht22}.
For systems without $i_\star$ measurements, it is still possible to infer their stellar obliquities from the sky-projected obliquities, assuming isotropic stellar inclinations. The inferred $\psi$ will have a larger uncertainty than the one inferred with known $i_\star$ \citep{Fabrycky09}.

We do not yet know the role of stellar inclinations in the population stellar obliquity distribution inference. 
In this work, we propose an approach to infer the stellar obliquity $\psi$ distribution from the sky-projected stellar obliquity $\lambda$ distribution. We show that the stellar obliquity distribution inference weakly depends on stellar inclination.
In Section~\ref{sec:hbm}, we introduce a flexible, hierarchical Bayesian framework to infer the population stellar obliquity distribution.
In Section~\ref{sec:applications}, we apply the framework to simulated data and real observations.
In Section~\ref{sec:jacobian}, we find the mathematical relation between the $\psi$, $\lambda$, and $i_\star$ distributions and explain why stellar inclination is not important in stellar obliquity distribution inference.

\section{Hierarchical Bayesian Framework}\label{sec:hbm}

To find the unknown stellar obliquity distribution of exoplanetary systems, we build a hierarchical Bayesian framework that takes the sky-projected stellar obliquity $\lambda$ and orbital inclination $i_{\rm orb}$ as observed data. Stellar inclination $i_\star$ is an optional and flexible input. It could be directly taken from previous observations, or if the rotational modulation technique is used, the stellar inclination will be inferred from the stellar rotation period $P_{\rm rot}$, stellar radius $R_\star$, and sky-projected rotational broadening velocity $v\sin{i}_\star$. If the stellar inclination information is not provided, we simply assume an isotropic stellar inclination. As we will show in later sections, assuming an isotropic stellar inclination will not compromise the stellar obliquity distribution inference.

\begin{figure}[ht!]
    \script{graph.py}
    \includegraphics[width=\linewidth]{figures/graph.pdf}
    \caption{Hierarchical Bayesian framework to infer the stellar obliquity distribution of exoplanetary systems. The stellar obliquity distribution is described by hyperparameters $\vb*{\beta}$ and constrained by $n_{\rm th}$ system's stellar obliquity $\psi_n$. Each $\psi_n$ is calculated by the system's sky-projected stellar obliquity $\lambda_n$, orbital inclination $i_{{\rm orb}, n}$, and stellar inclination $i_{\star, n}$, if available. $\gamma_{\star, n}$ contains properties of the star other than inclination, such as stellar radius and rotation period for $i_{\star, n}$ inference. Obs$_{\star,n}$ includes all the observed properties of the star with uncertainties, $\hat{\lambda}_n$ has the measured sky-projected stellar obliquity and its uncertainty, and $\hat{i}_{{\rm orb}, n}$ has measured orbital inclination and its uncertainty.}
    \label{fig:graph}
\end{figure}

Figure~\ref{fig:graph} shows the probabilistic graphical model for the hierarchical Bayesian framework. We aim to constrain a set of hyperparameters $\bm{\beta}$ that describe the stellar obliquity $\psi$ distribution. The parameter set $\bm{\beta}$ is constrained by $N$ individual systems in which $\psi_n$ is a random variable. $\psi_n$ is computed from the sky-projected stellar obliquity $\lambda_n$, the orbital inclination $i_{{\rm orb},n}$, and the stellar inclination $i_{\star, n}$. 
The parameter $\gamma_{\star, n}$ is a parameter set that contains all the stellar properties other than $i_\star$, e.g., stellar rotation period $P_{\rm rot}$ and radius $R_\star$, if the information is available.
Obs$_{\star,n}$ includes observed data that helps to constrain $i_{\star,n}$ and $\gamma_{\star, n}$.
If the rotational modulation method is used to constrain the stellar inclination, the $i_{\star,n}$ and $\gamma_{\star,n}$ are constrained by rotational modulation in photometric or spectroscopic time series and observed sky-projected stellar rotational line broadening $\hat{v}\sin{i_{\star,n}}$ \citep[e.g.,][]{Masuda20}, where we have $v\sin{i_\star} = 2 \pi R_\star / P_{\rm rot}$.
If the gravity-darkening method is used, the $i_{\star,n}$ is constrained by the anomaly in transit light curves. If asteroseismology is used, the $i_{\star,n}$ is constrained from the periodic variation in the photometric time series.
The sky-projected stellar obliquity $\lambda_n$ can be constrained by observed $\hat{\lambda}_n$ via the Rossiter-McLaughlin effect or gravity darkening.
Lastly, the orbital inclination $i_{{\rm orb},n}$ can be constrained from the transit light curves.

For the stellar obliquity distribution, we model the $\cos{\psi}$ distribution instead of $\psi$ distribution to understand if the stellar obliquity is isotropically distributed. If stellar obliquities of misaligned systems follow an isotropic distribution, the $\cos{\psi}$ distribution will be uniformly distributed between -1 to 1. We adopt a two-component mixture Beta distribution with hyperparameters $\bm{\beta} = \{\bm{w},\bm{a},\bm{b}\}$, where each hyperparameter has a dimension of 2. One component is designed for a large population of well-aligned systems, and the other is designed for misaligned systems. The Beta distribution is a flexible distribution that can describe the spike of aligned systems with stellar obliquities close to $0\degr$ or the clustered or broadly distributed misaligned systems.
The probability density function of $\cos{\psi}$ follows 
\begin{align}
    \cos{\psi} &\sim 2\times\Bigl( w_0 {\rm Beta}(a_0, b_0) + w_1 {\rm Beta}(a_1, b_1)\Bigr)-1.
\end{align}
Since the Beta distribution is defined on the interval $[0, 1]$, we extend its support to $[-1,1]$ using a linear transformation (i.e., $2\times {\rm Beta} - 1$). For the ${\rm Beta}(a_0,b_0)$ component, we have it to describe the population of aligned systems. For the $a_0/b_0 \gg 1$, the distribution will have a spike at $\cos{\psi} = 1$. For the ${\rm Beta}(a_1,b_1)$ component, we have it to describe the misaligned systems. We design the order of the two components to avoid label switching in the mixture model.
With the design, the hyperparameter and parameter priors are the following:
\begin{align}
    w_{0,1} &\sim {\rm Dirichlet}(1, 1) \nonumber\\
    a_0 &\sim \mathcal{U}(0, 50) \nonumber\\
    b_0 &\sim \mathcal{U}(0, 1) \nonumber\\
    a_1 &\sim \mathcal{U}(0, 10) \nonumber\\
    b_1 &\sim \mathcal{U}(0, 10) \nonumber\\
    \cos{i}_{\star,n} &\sim \mathcal{U}(0, 1) \nonumber\\
    \cos{i}_{{\rm orb},n} &\sim \mathcal{U}(-1, 1) \nonumber\\
    \lambda_{\star,n} &\sim \mathcal{U}(0, \pi).
\end{align}
The likelihood functions follow:
\begin{align}
    \mathcal{L}(\lambda) &\sim \prod_{i=1}^N\mathcal{N}(\hat{\lambda}_n, \sigma_{\hat{\lambda}_n}) \nonumber\\
    \mathcal{L}(i_\star) &\sim \prod_{i=1}^N\mathcal{N}({\rm Obs}_{\star,n}, \sigma_{{\rm Obs}_{\star,n}}).
\end{align}
If $\gamma_{\star, n}$ is available, we construct Normal distributions with means and standard deviations from their observed data.
Here we assume uniform hyperpriors for the Beta distribution. For population inference on a small number of systems (i.e., $N<50$), the choice of hyperpriors could impact the inferred distribution \citep{Nagpal22}. When applying the framework to small sample size, it is important to test the robustness of inferred distributions on different hyperpriors.

The probabilistic model is built with the $\mathtt{PyMC}$ \citep[$\mathtt{v4.1.7}$;][]{pymc} package and the posteriors are sampled using the No-U-Turn Sampler \citep[NUTS;][]{Hoffman11}, a gradient-based sampling algorithm of the Markov chain Monte Carlo (MCMC). All figures and simulations in this paper are fully reproducible and built with the $\mathtt{showyourwork}$ package. The open source code can be found on \href{https://github.com/jiayindong/polar}{GitHub\,\faGithub}.

\section{Applications to Simulated and Observational Data}\label{sec:applications}

\subsection{Simulated Data}

We first apply the hierarchical Bayesian framework to simulated data of which the ground-truth stellar obliquity distribution is known. We test the four $\cos{\psi}$ distributions: a uniform distribution $\mathcal{U}(-1,1)$ and three Normal distributions $\mathcal{N}(0,0.2)$, $\mathcal{N}(-0.4,0.2)$, and $\mathcal{N}(0.4,0.2)$.
For each $\cos{\psi}$ distribution, we randomly generate 200 samples of stellar inclination $i_\star$ and sky-projected stellar obliquity $\lambda$. We assume the stellar spin axis is uniformly distributed around the planetary orbital axis in the azimuthal direction and the orbital inclination is $90\degr$. 
The sampled $i_\star$ and $\lambda$ here are \emph{true} values. We then add some Gaussian noises to the \emph{true} $\lambda$ and $i_\star$ to simulate the \emph{observed} data. We choose uncertainties of $\sigma_{\lambda} = 8\degr$ and $\sigma_{i_\star} = 10\degr$, which are typical observational uncertainties summarized in \cite{Albrecht22}. Using the observed $\lambda$ and their uncertainties, we infer the $\cos{\psi}$ distribution of the sample with or without $i_\star$ likelihoods. 

In Figure~\ref{fig:simulation}, we present the inferred stellar obliquity distributions. Since the simulated stellar obliquity distributions only have a single component, we model the data with a single Beta distribution. Each row corresponds to an injected stellar obliquity distribution. The orange curve and contours are the median and uncertainties of the inferred $\cos{\psi}$ distribution with stellar inclination information, and the blue curve and contours are the ones without stellar inclination information. We simply assume an isotropic distribution of $i_\star$ for these models.
Surprisingly, in all four distributions, the inferred $\cos{\psi}$ distributions with or without $i_\star$ correctly recover the injected distributions shown as grey dashed lines as shown in Figure~\ref{fig:simulation}. Since some of the injected distributions are Normal distributions, it is expected that the inferred distributions, which as Beta distributions, could not exactly describe the injected distributions.

We also examine the importance of orbital inclination to the stellar obliquity inference. Since all the systems we study are transiting exoplanetary systems, we consider an isotropic orbital inclination distribution from $80\degr$ to $90\degr$. This broad inclination range corresponds to an impact parameter range from 0 to 1 for a circular orbit planet with an $a/R_\star$ of 6. We find at this level of orbital inclination deviations, the difference on the inferred stellar obliquity distributions is minimal. For transiting planet systems, approximating orbital inclinations to $90\degr$ will not compromise the stellar obliquity distribution inference.

From the simulated data, we confirm that while stellar inclinations help to constrain the stellar obliquity of individual systems, they are not necessarily required for the population stellar obliquity inference. The constraint on stellar obliquity distribution is predominantly based on sky-projected stellar obliquities, and the sky-projected stellar obliquity could correctly infer the peak and width of the underlying stellar obliquity distribution.

\begin{figure}[ht!]
    \script{simulation.py}
    \includegraphics[width=\linewidth]{figures/simulation.pdf}
    \caption{Inferred stellar obliquity distributions from sky-projected stellar obliquities with or without stellar inclination information. Each row presents a set of simulated data where the underlying $\cos{\psi}$ distribution is known and shown as grey dashed curves. The inferred $\cos{\psi}$ distributions with or without stellar inclination are shown in orange and blue curves, respectively. The shallow contours are $1\sigma$ and $2\sigma$ uncertainties of the inferred distributions.}
    \label{fig:simulation}
\end{figure}

\subsection{Exoplanetary Stellar Obliquity Distribution}

We then apply the hierarchical Bayesian framework to all exoplanetary systems with sky-projected stellar obliquity $\lambda$ measurements. We use the sample of 161 systems summarized in \cite{Albrecht22} Table A1, which are predominantly Hot Jupiter systems. The inferred $\cos{\psi}$ distribution is shown in Figure~\ref{fig:psi_dist}. The $\cos{\psi}$ distribution peaks at 1 but is nearly flat between $-0.75$ and $0.75$ with no significant clustering. The distribution corresponds to a pile-up of planets with stellar obliquity less than $40\degr$ and an isotropic distribution of planets with stellar obliquity from $40\degr$ to $140\degr$. 
The aligned-system population dominates the distribution with a fraction of $w_0 = 0.67 \pm 0.09$. The hyperposteriors of the Beta distribution are $a_0 = 31.0\pm12.8$ and $b_0 = 0.40\pm0.12$.
The misaligned-system population has a fraction of $w_1 = 0.33 \pm 0.09$ and hyperposteriors of $a_1 = 1.56\pm0.93$ and $b_1 = 1.64\pm1.58$.

\begin{figure}[ht!]
    \script{psi_dist.py}
    \begin{centering}
        \includegraphics{figures/psi_dist.pdf}
        \caption{Stellar obliquity distribution of all exoplanetary systems with sky-projected stellar obliquity measurements. The inference is purely from observed sky-projected stellar obliquities and assumes the stellar inclination is isotropic.}
        \label{fig:psi_dist}
    \end{centering}
\end{figure}

The inferred stellar obliquity distribution of the full sample of systems is at odds with the previous analysis of the subsample of systems that also have $i_\star$ measurements. The subsample identified a preponderance of perpendicular planets that disfavored an isotropic stellar obliquity distribution \citep{Albrecht21}. We speculate two possible explanations for this observation discrepancy, which are open to further investigation.
First, the sample of systems with $i_\star$ measurements is small, and only about 20 systems are misaligned systems used to constrain the misaligned systems' stellar obliquity distribution. Second, the sample could have a selection bias introduced by the $i_\star$ measurement requirement.

Our model identifies a pile-up of systems with stellar obliquity less than $40\degr$ and finds that misaligned systems have nearly isotropic stellar obliquity distribution. When comparing the inferred distribution with the prediction of stellar obliquity distributions in different Hot Jupiter origin scenarios, it is in best agreement with the outcome of the scattering of multiple giant planets after a convergent disk migration \citep[e.g.,][]{Nagasawa11, Beague12}. This particular intriguing result should be further examined on more carefully selected Hot Jupiter samples and put constraints on Hot Jupiter origin channels.

\section{Relations between the $\psi$, $\lambda$, and \lowercase{$i_\star$} distributions}\label{sec:jacobian}

In this section, we aim to use mathematical expressions to understand why the stellar obliquity distribution is predominantly determined by the sky-projected stellar obliquity distribution and why the stellar inclination distribution is less important to the inference.

\begin{figure*}[ht!]
    \script{coordinate.py}
    \gridline{
        \fig{figures/coord_psi.pdf}{0.45\textwidth}{\vspace*{-1.8cm}(a) The $\{\psi, \theta\}$ coordinate system. The grey circle corresponds to a constant $\psi$ value and its circumference is proportional to $\sin{\psi}$.}
        \fig{figures/coord_lam.pdf}{0.45\textwidth}{\vspace*{-1.8cm}(b) The $\{\lambda, i_\star\}$ coordinate system. The grey circle corresponds to a constant $i_\star$ value and its circumference is proportional to $\sin{i_\star}$.}
    }
    \vspace*{-1.5cm}
    \caption{Two coordinate systems to describe the stellar spin axis $\bf{n}_{\star}$ and the planet's orbital axis $\bf{n}_{\rm orb}$. Here we define the observer's line of sight as one of the two horizontal axes (conventional $x$-axis in Cartesian), and the orbital axis of the planet as the vertical axis (conventional $z$-axis in Cartesian). We approximate the orbital inclination of the planet to $90\degr$.}
    \label{fig:coord}
\end{figure*}

In Figure~\ref{fig:coord}, we build two coordinate systems to describe the stellar spin axis $\bf{n}_{\star}$ for a given orbital axis $\bf{n}_{\rm orb}$. In both coordinates, we set the observer's line of sight to be one of the two horizontal axes, and the orbital axis of the planet to be the vertical axis. We approximate the orbital inclination of the transiting planet to $90\degr$ here to simplify the problem for a population study. We found in the previous section that the assumption would not compromise the stellar obliquity distribution inference for transiting planets.

The $\{\psi, \theta\}$ coordinate system shown in panel (a) relates to the physical properties of a planetary system. $\psi$ is the angle between the stellar spin axis and the planetary orbital axis, and $\theta$ is the azimuthal angle of the stellar spin axis. For the given $\bf{n}_{\rm orb}$ axis, if $\bf{n}_{\star}$ is a random vector with uniform distribution on a three-dimensional sphere, i.e., $\bf{n}_{\star}$ is isotropically distributed, the probability density function of $\psi$ follows $p_{\psi} \sim \sin{\psi}$ and $p_\theta \sim 1/2\pi$. Since $p_{\cos{\psi}} = p_{\psi} \abs{\dv*{\psi}{\cos{\psi}}}$, $p_{\cos{\psi}}$ is uniformly distributed between $-1$ and $1$ for isotropic stellar obliquity.
The $\{\lambda, i_\star\}$ coordinate system shown in panel (b) relates to observed properties. $\lambda$ is the sky-projected stellar obliquity and $i_\star$ is the stellar inclination. If $\bf{n}_{\star}$ is isotropically distributed, $p_{i_\star} \sim \sin{i_\star}$ and $p_\lambda \sim 1/2\pi$. Again, since $p_{\cos{i_\star}} = p_{i_\star} \abs{\dv*{i_\star}{\cos{i_\star}}}$, $p_{\cos{i_\star}}$ is uniformly distributed between $-1$ and $1$. Because of the observational degeneracy between $i_\star$ and $180\degr - i_\star$, the convention is to have $0 \leq i_\star \leq 90\degr$, and thus $p_{\cos{i_\star}}$ is uniformly distributed between $0$ and $1$ (i.e., $p_{\cos{i_\star}} \sim 1$). This also limits $\theta$ to $[-\pi/2, \pi/2]$. 
In observation, there is also a degeneracy between $-\lambda$ and $+\lambda$. Therefore, we also limit $\lambda$ to $[0,\pi]$.

We could find the mathematical relations between $\{\psi, \theta\}$ and $\{\lambda, i_\star\}$ by pairing the Cartesian components of $\bf{n}_{\star}$ in two coordinate systems:
\begin{align}
    \sin{\psi}\cos{\theta} = \cos{i_\star}& \label{eq:coord1}\\
    \sin{\psi}\sin{\theta} = \sin{\lambda}\sin{i_\star}& \label{eq:coord2}\\
    \cos{\psi} = \cos{\lambda}\sin{i_\star} \label{eq:coord3}&.
\end{align}
Thus, $i_\star = \cos[-1](\sin{\psi}\cos{\theta})$ and $\lambda = \tan[-1](\tan{\psi}\sin{\theta})$. 

First, we derive the $\lambda$ distribution for a given $\cos{\psi}$ distribution. We could find the distribution of $\cos{\lambda}$ using the Jacobian transformation from $\cos{\psi}$ and $\cos{\theta}$. Since $\psi$ and $\theta$ are independent variables, we could marginalize over $\theta$ to find the relation between the probability density functions between $\lambda$ and $\psi$.
The Jacobian transformation follows
\begin{equation}
    p_{\cos{\lambda}} = \int \abs{\pdv{\cos{\psi}}{\cos{\lambda}}} p_{\cos{\psi}} p_{\cos{\theta}} d\cos{\theta}.
\end{equation}
Replacing $\sin{i_\star}$ in Equation~(\ref{eq:coord3}) with Equation~(\ref{eq:coord1}), we find $\cos{\lambda} = \cos{\psi}/\sqrt{1-(1-\cos^2{\psi})\cos^2{\theta}}$. Reorganize the equation, we get $\cos^2{\psi} = \frac{\cos^2{\lambda}\cos^2{\theta}-\cos^2{\lambda}}{\cos^2{\lambda}\cos^2{\theta}-1}$.
The derivative gives $\abs{\pdv{\cos{\psi}}{\cos{\lambda}}} = \frac{(1-\cos^2{\theta})^{1/2}}{(1-\cos^2{\theta}\cos^2{\lambda})^{3/2}}$. If $\theta$ is uniformly distributed between $-\pi/2$ and $\pi/2$, $p_{\cos{\theta}} = p_{\theta} \abs{\dv*{\theta}{\cos{\theta}}} = 1/\pi/(1-\cos^2{\theta)^{1/2}}$. Putting all the parts together, we get
\begin{equation}\label{eqn:jac_lam}
    p_{\cos{\lambda}} = \frac{2}{\pi} \int_{0}^{1} (1-\cos^2{\theta}\cos^2{\lambda})^{-3/2} p_{\cos{\psi}} d\cos{\theta}.
\end{equation}
If $\cos{\psi}$ is uniformly distribution, i.e., $p_{\cos{\psi}} = 1/2$, Equation~(\ref{eqn:jac_lam}) becomes $p_{\cos{\lambda}} = 1/\pi/\sqrt{1-\cos^2{\lambda}}$, which is equivalent to $p_\lambda = 1/\pi$. The $\lambda$ is uniformly distributed if an isotropic $\psi$. If $\cos{\psi}$ follows other distributions, $p_\lambda$ could be found by evaluating Equation~(\ref{eqn:jac_lam}) numerically.

Next, we derive the $i_\star$ distribution for a given $\cos{\psi}$ distribution. Similarly, we first find the Jacobian transformation of $i_\star$ from $\psi$ and $\theta$ and then marginalize over $\theta$. It is easier to work on $\cos{i_\star}$ than $i_\star$:
\begin{equation}
    p_{\cos{i_\star}} = \int \abs{\pdv{\sin{\psi}}{\cos{i_\star}}} p_{\sin{\psi}} p_{\cos{\theta}} d\cos{\theta}.
\end{equation}
From Equation~(\ref{eq:coord1}), we have $\sin{\psi} = \cos{i_\star}/\cos{\theta}$ and $\abs{\pdv{\sin{\psi}}{\cos{i_\star}}} = 1/\cos{\theta}$. Again, we assume $\theta$ is uniformly distributed, and $p_{\cos{\theta}} = 1/\pi/(1-\cos^2{\theta)^{1/2}}$. Lastly, we transform the $p_{\sin{\psi}}$ to $p_{\cos{\psi}}$, where $p_{\sin{\psi}} = p_{\cos{\psi}}\sqrt{1-\cos^2{\psi}}/\cos{\psi}$. Combining all the pieces together, we get
\begin{equation}\label{eqn:jac_istar}
    p_{\cos{i_\star}} = \frac{4}{\pi} \int_{\cos{i_\star}}^{1} \frac{\cos{i_\star}/\cos{\theta}}{\sqrt{\cos^2{\theta}-\cos^2{i_\star}}} \frac{1}{\sqrt{1-\cos^2{\theta}}} p_{\cos{\psi}} d\cos{\theta}.
\end{equation}
If $\cos{\psi}$ is uniformly distribution, i.e., $p_{\cos{\psi}} = 1/2$, the integral gives $1$, which suggests the $\cos{i_\star}$ probability density function is uniform.

From Equation~(\ref{eqn:jac_lam}) and (\ref{eqn:jac_istar}), we can now derive the $\lambda$ and $i_\star$ distributions for any given $\psi$ distributions, assuming the azimuthal angle of the stellar spin axis $\theta$ is random. In Figure~\ref{fig:transform}, we find and examine numerical solutions of the $\lambda$ and $i_\star$ distributions for four different $\cos{\psi}$ distributions. The first row in Figure~\ref{fig:transform} presents an isotropic $\psi$ where $\cos{\psi} \sim \mathcal{U}(-1,1)$, and the second to fourth rows in Figure~\ref{fig:transform} present Normal distributions of $\cos{\psi}$ following $\mathcal{N}(0,0.2)$, $\mathcal{N}(-0.4,0.2)$, and $\mathcal{N}(0.4,0.2)$, respectively. In each row, we solve the $\lambda$ and $i_\star$ distributions numerically as shown in blue curves, and samplings of $\lambda$ and $i_\star$ from $\cos{\psi}$ and $\theta$ distributions as shown in grey histograms. For a uniform $\cos{\psi}$ distribution, the $\lambda$ distribution is uniform, and the $i_\star$ distribution is isotropic and proportional to $\sin{i_\star}$, as expected.

Interestingly, for a given stellar obliquity distribution, the $\lambda$ distribution is sensitive to and closely related to the underlying $\psi$ distribution, as shown in Figure~\ref{fig:transform}. For different stellar obliquity distributions, the $\lambda$ distributions are distinguishable from each other, and thus, when we infer the $\psi$ distribution from the $\lambda$ distribution, the solution will not degenerate.
On the other hand, the $i_\star$ distributions less depend on the underlying $\psi$ distribution. Compared to an isotropic $i_\star$ distribution, the $i_\star$ distributions for different $\psi$ distributions differ at the low values (i.e., $i_\star < \pi/4$), which places a challenge to observation. More importantly, since the $i_\star$ distributions are less sensitive to the underlying $\psi$ distributions when we infer the $\psi$ distributions from the $i_\star$ distribution, the solution could be very degenerate.

Due to the lack of dependency on the $i_\star$ distribution, the $\psi$ distribution could be inferred purely from the $\lambda$ distribution without losing much information. Although we could find a relation between $\psi$, $\lambda$, and $\theta$, the $\psi$ distribution cannot be inferred from the $\lambda$ and $\theta$ distributions since $\lambda$ and $\theta$ are not independent variables. We still need to infer the $\psi$ distribution from the $\lambda$ and $i_\star$ distributions.
In the \nth{4} column in Figure~\ref{fig:transform}, we find the $\psi$ distribution from the $\lambda$ distribution, simply assuming an isotropic $i_\star$ distribution. The method could correctly recover the peaks and widths of the underlying $\psi$ distributions (presented as blue dashed lines) as shown in grey histograms. The method over-predicts $\cos{\psi}$ at $\pm 1$ because of the over-prediction of $i_\star$ near $90\degr$. However, this minor deviation from the true distribution has little impact on the population inference because of hyperparameters' limited degree of freedom. Comparing the blue curves with the orange curves in Figure~\ref{fig:simulation}, the overestimation of $\cos{\psi}$ near $\pm1$ under the assumption of an isotropic $i_\star$ has little impact on the inference since the distribution is mainly constrained by the peak and width of the stellar obliquity distribution, which are both correctly predicted by the isotropic $i_\star$ model.


\begin{figure*}[ht!]
    \script{transform.py}
    \includegraphics[width=\linewidth]{figures/transform.pdf}
    \caption{Simulated $\cos{\psi}$ distributions (\nth{1} column) and their corresponding sky-projected stellar obliquity $\lambda$ (\nth{2} column) and stellar inclination $i_\star$ (\nth{3} column) distributions. The inferred $\cos{\psi}$ distributions assuming isotropic stellar inclinations are shown in the \nth{4} column. The random samplings of $\lambda$ and $i_\star$ out of the $\cos{\psi}$ distributions are shown as grey histograms, and the numerical solutions are shown as blue curves.}
    \label{fig:transform}
\end{figure*}

\section{Summary \& Discussion}

In this work, we demonstrate the stellar obliquity distribution inference is predominantly based on the sky-projected stellar obliquity. While stellar inclination improves the stellar obliquity constraint on individual systems, it does not improve the population-level stellar obliquity constraint. 
We introduce a flexible, hierarchical Bayesian framework to infer the stellar obliquity distribution of a population. Information on stellar inclination is not required for the stellar obliquity distribution inference; if the stellar inclination is not provided, we simply assume an isotropic stellar inclination distribution. When combining samples with and without stellar inclination measurements, it is important to check if the $i_\star$ sample is representative of the full sample. If not, since the $i_\star$ sample will constrain stellar obliquities more tightly, the overall distribution could be weighted towards these systems, bias our interpretation.
The hierarchical Bayesian model we introduce in this paper is an open-source code available to the public to apply to a certain sample of targets and customize for different stellar obliquity distributions and priors.

When applying our framework to all exoplanetary systems with sky-projected stellar obliquity measurements, we found no significant clustering near $\cos{\psi} = 0$, at odds with the previous study of systems that have both sky-projected stellar obliquity and stellar obliquity measurements. Potential biases that lead to this discrepancy are open to discussion. 
Their stellar obliquity is nearly isotropically distributed for misaligned exoplanetary systems in support of a multi-planet, convergent-disk-migration history followed by a scattering phase in these planets' dynamical history. Future studies on a more carefully selected Hot Jupiter sample will put better constraints on the origin of Hot Jupiters from their stellar obliquity distribution.

% \section{More}

% First, we apply the framework to the sample of \numistar systems that have both sky-projected stellar obliquity $\lambda$ and stellar inclination $i_\star$ constraints summarized in the \cite{Albrecht22} review. If the host star's rotation period is available, we use the value along with the stellar radii and $v\sin{i_\star}$ to infer the stellar inclination. Otherwise, we use the reported stellar inclination and uncertainty listed in Table A1 of \cite{Albrecht22}.
% The inferred $\cos{\psi}$ distribution is shown in the left panel of Figure~\ref{fig:psi_dist}. The distribution presents a pike at 1, suggesting the majority of exoplanetary systems are well-aligned systems. For misaligned systems, $\cos{\psi}$ presents a cluster near $\cos{\psi} = -0.2$, corresponding to $\psi$ of $100\degr$. The result is consistent with the findings of a preponderance of perpendicular planets in \cite{Albrecht21}.

% To test the dependence of $\cos{\psi}$ distribution on $i_\star$ measurements, we apply the model again to the sample of \numistar systems with both constrained $\lambda$ and $i_\star$. However, in this model, we do not use any additional information on $i_\star$ other than applying an isotropic inclination prior to each system. The corresponding probabilistic graphical model is Figure~\ref{fig:graph} but removing all the dashed edges.
% The $\cos{\psi}$ distribution of the new model is shown in the middle panel of Figure~\ref{fig:psi_dist}. Interestingly, the overall $\cos{\psi}$ distributions of the two models are very similar, despite the fact that the inferred $\psi$ uncertainty for each system is now greater.
% The similarity between the two distributions suggests that, at least for the observed-$i_\star$ sample, the $\cos{\psi}$ distribution mainly depends on the underlying sky-project stellar obliquity $\lambda$ distribution.

% Consequently, we apply our model to all \numall exoplanetary systems that have sky-projected stellar obliquity measurements summarized in \cite{Albrecht22}. The result is presented in the right panel of Figure~\ref{fig:psi_dist}. The $\cos{\psi}$ distribution still spikes at 1 but is nearly flat between $-0.75$ and $0.75$ with no significant clustering. The distribution corresponds to an isotropic distribution of $\psi$ from $40\degr$ to $140\degr$.

% There is no doubt that $i_\star$ measurement on an individual system improves the constraint on $\psi$. However, are $i_\star$ measurements required to constrain the population $\psi$ distribution? Particularly, the left and middle panels in Figure~\ref{fig:psi_dist} show that without $i_\star$ measurements, a similar level of constraint on the $\cos{\psi}$ distribution can be achieved. We perform some calculations and tests to evaluate the necessity of $i_\star$ constraints.
 
% We also design some $\cos{\psi}$ distributions and infer their distributions purely from the $\lambda$ distributions. From each distribution of $\cos{\psi}$ and assuming a uniform $\theta$, we randomly generate 200 samples of $i_\star$ and $\lambda$ and assume them as \emph{true} values. We then add some Gaussian noises to \emph{true} $\lambda$ and $i_\star$ to simulate \emph{observed} values. We use the uncertainties of $\sigma_{\lambda} = 8\degr$ and $\sigma_{i_\star} = 10\degr$ which are typical observation uncertainties. Lastly, from the observed values and their uncertainties, we infer the $\cos{\psi}$ distribution of the sample with or without $i_\star$ measurements.
% We test four different distributions of $\cos{\psi}$: a uniform distribution $\mathcal{U}(-1,1)$ and three Normal distributions $\mathcal{N}(0,0.2)$, $\mathcal{N}(-0.4,0.2)$, and $\mathcal{N}(0.4,0.2)$.
% In all four distributions, we find inferences with or without $i_\star$ are consistent with each other and injected distributions.

% We find the underlying $\lambda$ distributions of the observed-$i_\star$ sample and the full sample by building another hierarchical Bayesian model. We again use a two-component mixture Beta distribution to describe well-aligned and misaligned systems. We extend the Beta distribution support from $[0,1]$ to $[0,\pi]$ by multiplying the distribution by $\pi$. We use the observed $\lambda$ and uncertainties for the likelihoods. Figure~\ref{fig:lam_dist} shows the $\lambda$ distributions of two samples. It clearly shows that in the observed-$i_\star$ sample, misaligned systems are clustered at $\sim 110\degr$, whereas in the full sample, misaligned systems are nearly uniformly distributed. 

% The stellar obliquity distribution of exoplanetary systems can be inferred purely from their sky-projected stellar obliquity distribution. When we apply our framework to all systems with $\lambda$ measurements, we find misaligned systems have nearly isotropic stellar obliquity distribution. We compare the inferred distribution from the observation to the prediction of mutual inclination of different eccentricity excitation mechanisms of Hot Jupiters. It is in best agreement with the outcome of the scattering of multiple giant planets after a convergent disk migration \citep{Beague12}.

\vspace{5mm}

\software{$\mathtt{ArviZ}$ \citep{arviz_2019}, $\mathtt{Jupyter}$ \citep{Jupyter}, $\mathtt{Matplotlib}$ \citep{Matplotlib07, Matplotlib16}, $\mathtt{NumPy}$ \citep{NumPy11, NumPy20}, $\mathtt{pandas}$ \citep{mckinney-proc-scipy-2010, reback2020pandas}, $\mathtt{PyMC}$ \citep{pymc}, $\mathtt{SciPy}$ \citep{2020SciPy-NMeth}}

\bibliography{bib}

\end{document}
